Import('env')
Import('parallel_run')
Import('type')
Import('serial_run')

Import('bin_path')
Import('test_path')

env['COPY'] = ''

# Define a test for running unit tests

copy_bin     = Builder(action = "cp $SOURCE $ARGS");
run_serial   = Builder(action = serial_run   +  "$SOURCE $ARGS > $TARGET 2>&1; $COPY")
run_parallel = Builder(action = parallel_run + " $SOURCE $ARGS > $TARGET 2>&1; $COPY")
run_method   = Builder(action = serial_run   + " $SOURCE > $ARGS 2>&1")
make_movie   = Builder(action = "png2swf -r 5 -o $TARGET ${ARGS} ")

env.Append(BUILDERS = { 'RunSerial'   : run_serial } ) 
env.Append(BUILDERS = { 'RunParallel' : run_parallel } )
env.Append(BUILDERS = { 'MakeMovie'   : make_movie } )
env.Append(BUILDERS = { 'RunMethod'   : run_method } )

env_mv_png  = env.Clone(COPY = 'mv *.png ' + test_path)
env_mv_test = env.Clone(COPY = 'mv test*out test*in ' + test_path)

#----------------------------------------------------------------------
# DISK COMPONENT          
#----------------------------------------------------------------------
Clean(env.RunSerial
      ('test_FileHdf5.unit',  bin_path + '/test_FileHdf5'),
      '#test_disk.h5')
       
Clean(env.RunSerial
      ('test_FileIfrit.unit', bin_path + '/test_FileIfrit'),
      '#/FileIfrit_test.bin')
#----------------------------------------------------------------------
# ENZO COMPONENT          
#----------------------------------------------------------------------
#----------------------------------------------------------------------
# ERROR COMPONENT         
#----------------------------------------------------------------------
env.RunSerial('test_Error.unit',       bin_path + '/test_Error')
#----------------------------------------------------------------------
# FIELD COMPONENT         
#----------------------------------------------------------------------
env.RunSerial('test_FieldBlock.unit',bin_path + '/test_FieldBlock')
env.RunSerial('test_FieldDescr.unit',bin_path + '/test_FieldDescr')
env.RunSerial('test_FieldFace.unit', bin_path + '/test_FieldFace')
env.RunSerial('test_ItField.unit',   bin_path + '/test_ItField')
#----------------------------------------------------------------------
# IO COMPONENT        
#----------------------------------------------------------------------
env.RunSerial('test_ItReduce.unit',      bin_path + '/test_ItReduce')
#----------------------------------------------------------------------
#----------------------------------------------------------------------
# MEMORY COMPONENT        
#----------------------------------------------------------------------
env.RunSerial('test_Memory.unit',      bin_path + '/test_Memory')
#----------------------------------------------------------------------
# METHOD COMPONENT
#----------------------------------------------------------------------
#----------------------------------------------------------------------
# MESH COMPONENT          
#----------------------------------------------------------------------
env.RunSerial('test_Hierarchy.unit', bin_path + '/test_Hierarchy')
env.RunSerial('test_Patch.unit',     bin_path + '/test_Patch')
env.RunSerial('test_Block.unit',     bin_path + '/test_Block')
#----------------------------------------------------------------------
# MONITOR COMPONENT       
#----------------------------------------------------------------------
env.RunSerial('test_Monitor.unit',      bin_path + '/test_Monitor')
#----------------------------------------------------------------------
# PARALLEL COMPONENT      
#----------------------------------------------------------------------
env.RunSerial('test_Layout.unit',      bin_path + '/test_Layout')
#----------------------------------------------------------------------
# PARAMETERS COMPONENT    
#----------------------------------------------------------------------
Clean(env_mv_test.RunSerial
      ('test_Parameters.unit',  bin_path + '/test_Parameters'),
      ['#/test.in','#/test1.out','#/test2.out'])
#----------------------------------------------------------------------
# PARTICLE COMPONENT
#----------------------------------------------------------------------
#----------------------------------------------------------------------
# PERFORMANCE COMPONENT   
#----------------------------------------------------------------------
env.RunSerial('test_Performance.unit', bin_path + '/test_Performance')
env.RunSerial('test_Papi.unit',        bin_path + '/test_Papi')
#----------------------------------------------------------------------
# PORTAL COMPONENT        
#----------------------------------------------------------------------
#----------------------------------------------------------------------
# SIMULATION COMPONENT    
#----------------------------------------------------------------------

# (test_Simulation removed since supplanted by enzo-p)

#----------------------------------------------------------------------
# TEST INPUT PARAMETER PARSER
#----------------------------------------------------------------------

env.RunSerial('parse_groups.unit',     bin_path + '/test_Parse', ARGS='input/parse_groups.in')
env.RunSerial('parse_integer.unit',    bin_path + '/test_Parse', ARGS='input/parse_integer.in')
env.RunSerial('parse_list.unit',       bin_path + '/test_Parse', ARGS='input/parse_list.in')
env.RunSerial('parse_logical.unit',    bin_path + '/test_Parse', ARGS='input/parse_logical.in')
env.RunSerial('parse_scalar.unit',     bin_path + '/test_Parse', ARGS='input/parse_scalar.in')
env.RunSerial('parse_include.unit',    bin_path + '/test_Parse', ARGS='input/parse_include.in')
env.RunSerial('parse_implosion.unit',  bin_path + '/test_Parse', ARGS='input/problem_implosion.in')

#----------------------------------------------------------------------
# TEST FULL APPLICATION
#----------------------------------------------------------------------

Clean(env_mv_png.RunSerial ('test_method_ppm-1.unit',bin_path + '/enzo-p', 
		ARGS='input/method_ppm-1.in'),
      [Glob('#/' + test_path + '/method_ppm-1-??????-*.png'),
       Glob('#/' + test_path + '/method_ppm-1-??-??????.h5'),
       'test_method_ppm-1.unit', '#/input/method_ppm-1.in.out'])

env.MakeMovie ("method_ppm-1.swf", "test_method_ppm-1.unit", \
                ARGS= test_path + "/method_ppm-1-??????.png");


Clean(env_mv_png.RunParallel ('test_method_ppm-8.unit',bin_path + '/enzo-p', 
		ARGS='input/method_ppm-8.in'),
      [Glob('#/' + test_path + '/method_ppm-8-??????-*.png'),
      Glob('#/' + test_path + '/method_ppm-8-??-??????.h5'),
       'test_method_ppm-8.unit', '#/input/method_ppm-8.in.out'])

env.MakeMovie ("method_ppm-8.swf", "test_method_ppm-8.unit", \
                ARGS= test_path + "/method_ppm-8-??????.png");

Clean(env_mv_png.RunSerial ('test_method_ppml-1.unit',bin_path + '/enzo-p', 
		ARGS='input/method_ppml-1.in'),
      [Glob('#/' + test_path + '/method_ppml-1-?-????-*.png'),
       Glob('#/' + test_path + '/method_ppml-1-??-????-*.h5'),
       'test_method_ppml-1.unit', '#/input/method_ppml-1.in.out'])

env.MakeMovie ("method_ppml-1-x.swf", "test_method_ppml-1.unit", \
                ARGS= test_path + "/method_ppml-1-x-????.png");
env.MakeMovie ("method_ppml-1-y.swf", "test_method_ppml-1.unit", \
                ARGS= test_path + "/method_ppml-1-y-????.png");
env.MakeMovie ("method_ppml-1-z.swf", "test_method_ppml-1.unit", \
                ARGS= test_path + "/method_ppml-1-z-????.png");

Clean(env_mv_png.RunParallel ('test_method_ppml-8.unit',bin_path + '/enzo-p', 
		ARGS='input/method_ppml-8.in'),
      [Glob('#/' + test_path + '/method_ppml-8-?-????-*.png'),
       Glob('#/' + test_path + '/method_ppml-8-??-????-*.h5'),
       'test_method_ppml-8.unit', '#/input/method_ppml-8.in.out'])

env.MakeMovie ("method_ppml-8-x.swf", "test_method_ppml-8.unit", \
                ARGS= test_path + "/method_ppml-8-x-????.png");
env.MakeMovie ("method_ppml-8-y.swf", "test_method_ppml-8.unit", \
                ARGS= test_path + "/method_ppml-8-y-????.png");
env.MakeMovie ("method_ppml-8-z.swf", "test_method_ppml-8.unit", \
                ARGS= test_path + "/method_ppml-8-z-????.png");

#----------------------------------------------------------------------
# BOUNDARY CONDITIONS
#----------------------------------------------------------------------

# 2D


Clean(env_mv_png.RunParallel ('test_boundary_reflecting-2d.unit',
                bin_path + '/enzo-p', 
                ARGS='input/boundary_reflecting-2d.in'),
      [Glob('#/' + test_path + '/boundary_reflecting-2d.png'),
       'test_boundary_reflecting-2d.unit',
       '#/input/boundary_reflecting-2d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_periodic-2d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_periodic-2d.in'),
      [Glob('#/' + test_path + '/boundary_periodic-2d.png'),
       'test_boundary_periodic-2d.unit',
       '#/input/boundary_periodic-2d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_inflow-2d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_inflow-2d.in'),
      [Glob('#/' + test_path + '/boundary_inflow-2d.png'),
       'test_boundary_inflow-2d.unit',
       '#/input/boundary_inflow-2d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_outflow-2d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_outflow-2d.in'),
      [Glob('#/' + test_path + '/boundary_outflow-2d.png'),
       'test_boundary_outflow-2d.unit',
       '#/input/boundary_outflow-2d.in.out'])

# NOTE: dependencies don't work with running tests: need to specify run output)

env.MakeMovie ("boundary_reflecting-2d.swf", 
               "test_boundary_reflecting-2d.unit", \
                ARGS= test_path + "/boundary_reflecting-2d-????.png");
env.MakeMovie ("boundary_periodic-2d.swf","test_boundary_periodic-2d.unit", \
                ARGS= test_path + "/boundary_periodic-2d-????.png");
env.MakeMovie ("boundary_inflow-2d.swf","test_boundary_inflow-2d.unit", \
                ARGS= test_path + "/boundary_inflow-2d-????.png");
env.MakeMovie ("boundary_outflow-2d.swf","test_boundary_outflow-2d.unit", \
                ARGS= test_path + "/boundary_outflow-2d-????.png");
# 3D


Clean(env_mv_png.RunParallel ('test_boundary_reflecting-3d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_reflecting-3d.in'),
      [Glob('#/' + test_path + '/boundary_reflecting-3d.png'),
       'test_boundary_reflecting-3d.unit',
       '#/input/boundary_reflecting-3d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_periodic-3d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_periodic-3d.in'),
      [Glob('#/' + test_path + '/boundary_periodic-3d.png'),
       'test_boundary_periodic-3d.unit',
       '#/input/boundary_periodic-3d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_inflow-3d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_inflow-3d.in'),
      [Glob('#/' + test_path + '/boundary_inflow-3d.png'),
       'test_boundary_inflow-3d.unit',
       '#/input/boundary_inflow-3d.in.out'])

Clean(env_mv_png.RunParallel ('test_boundary_outflow-3d.unit',
		bin_path + '/enzo-p', 
		ARGS='input/boundary_outflow-3d.in'),
      [Glob('#/' + test_path + '/boundary_outflow-3d.png'),
       'test_boundary_outflow-3d.unit',
       '#/input/boundary_outflow-3d.in.out'])

env.MakeMovie ("boundary_reflecting-3d.swf","test_boundary_reflecting-3d.unit",
                ARGS= test_path + "/boundary_reflecting-3d-????.png");
env.MakeMovie ("boundary_periodic-3d.swf","test_boundary_periodic-3d.unit", \
                ARGS= test_path + "/boundary_periodic-3d-????.png");
# env.MakeMovie ("boundary_inflow-3d.swf","test_boundary_inflow-3d.unit", \
#                 ARGS= test_path + "/boundary_inflow-3d-????.png");
env.MakeMovie ("boundary_outflow-3d.swf","test_boundary_outflow-3d.unit", \
                ARGS= test_path + "/boundary_outflow-3d-????.png");


Clean(env_mv_png.RunParallel ('test_initial_png.unit',
		bin_path + '/enzo-p', 
		ARGS='input/initial_png.in'),
      [Glob('#/' + test_path + '/initial_png.png'),
       'test_initial_png.unit',
       '#/input/initial_png.in.out'])
env.MakeMovie ("initial_png.swf","test_initial_png.unit", \
                ARGS= test_path + "/initial_png-??.png");

if (type == "serial"):
   env.RunParallel	('test_GroupProcess.unit',bin_path + '/test_GroupProcess',ARGS='1')
else:
   env.RunParallel	('test_GroupProcess.unit',bin_path + '/test_GroupProcess',ARGS='8')


# env.MakeMovie('ppm-density.mpg',      '#/ppm-density-00000.png', ARGS='ppm-density-?????.png')

# env.RunParallel('test_affinity.unit',   bin_path + '/test_Affinity')

	# env.RunParallel('test_mpi.unit',        bin_path + '/test_Mpi')
# env.RunParallel('test_jacobi.unit',        bin_path + '/test_jacobi')

# Prevent concurrent running of parallel jobs

SideEffect('log.txt', 
     [ 'test_GroupProcess.unit', 
       'method_ppm-1.unit',
       'method_ppm-8.unit'])



