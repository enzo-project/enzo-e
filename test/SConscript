Import('env')
Import('platform')

# Define a test for running unit tests
unit       = Builder(action = "$SOURCE > $TARGET")
unit_args  = Builder(action = "$SOURCE $ARGS > $TARGET")
unit_parse = Builder(action = "$SOURCE < $ARGS > $TARGET")

# @@@ MOVE PLATFORM-DEPENDENT CODE TO TOP LEVEL

if (platform == 'linux-mpi'):
   unit_mpi   = Builder(action = "mpirun -np 4 $SOURCE > $TARGET")
   test_cello = Builder(action = "mpirun -np 4 $SOURCE $ARGS > $TARGET")
elif (platform == 'linux-ampi'):
   unit_mpi   = Builder(action = "/home/bordner/charm/charm-6.2.0/bin/charmrun ++p 4 $SOURCE > $TARGET")
   test_cello = Builder(action = "/home/bordner/charm/charm-6.2.0/bin/charmrun ++p 4 $SOURCE $ARGS > $TARGET")
elif (platform == 'triton'):
   unit_mpi = Builder(action = "/opt/openmpi_pgimx/bin/mpirun -np 4 $SOURCE > $TARGET")
   test_cello = Builder(action = "/opt/openmpi_pgimx/bin/mpirun -np 4 $SOURCE $ARGS> $TARGET")
elif (platform == 'ncsa-bd'):
   unit_mpi = Builder(action = "")
   test_cello = Builder(action = "")
else:
   unit_mpi = Builder(action = "$platform $SOURCE > $TARGET")
   test_cello = Builder(action = "$SOURCE $ARGS> $TARGET")

# BUG: bin/cello does not necessarily get built before running test_cello, e.g.
# BUG: from inside test directory after a clean


env.Append(BUILDERS = { 'Unit': unit } )
env.Append(BUILDERS = { 'UnitArgs':   unit_args } ) 
env.Append(BUILDERS = { 'UnitMpi' :   unit_mpi } )
env.Append(BUILDERS = { 'UnitParse' : unit_parse } )
env.Append(BUILDERS = { 'TestCello' : test_cello } )

env.Unit('test_Mesh.out',        '#/bin/test_Mesh')
env.Unit('test_Array.out',       '#/bin/test_Array')
env.Unit('test_Data.out',        '#/bin/test_Data')
env.Unit('test_FieldDescr.out',  '#/bin/test_FieldDescr')
env.Unit('test_FieldBlock.out',  '#/bin/test_FieldBlock')
env.Unit('test_Hdf5.out',        '#/bin/test_Hdf5')
env.Unit('test_Ifrit.out',       '#/bin/test_Ifrit')
env.Unit('test_Error.out',       '#/bin/test_Error')
env.Unit('test_Layout.out',      '#/bin/test_Layout')
env.Unit('test_Memory.out',      '#/bin/test_Memory')
env.Unit('test_Mesh.out',        '#/bin/test_Mesh')
env.Unit('test_Parameters.out',  '#/bin/test_Parameters')
env.Unit('test_Performance.out', '#/bin/test_Performance')
env.Unit('test_Schedule.out',    '#/bin/test_Schedule')
env.Unit('test_Simulation.out',  '#/bin/test_Simulation')

env.UnitArgs('test_TreeK-D2-R2-L6.out', '#/bin/test_TreeK', ARGS='2 2 6')
env.UnitArgs('test_TreeK-D2-R2-L8.out', '#/bin/test_TreeK', ARGS='2 2 8')
env.UnitArgs('test_TreeK-D2-R2-L10.out','#/bin/test_TreeK', ARGS='2 2 10')
env.UnitArgs('test_TreeK-D2-R2-L11.out','#/bin/test_TreeK', ARGS='2 2 11')
env.UnitArgs('test_TreeK-D2-R2-L12.out','#/bin/test_TreeK', ARGS='2 2 12')
env.UnitArgs('test_TreeK-D2-R4-L6.out', '#/bin/test_TreeK', ARGS='2 4 6')
env.UnitArgs('test_TreeK-D2-R4-L8.out', '#/bin/test_TreeK', ARGS='2 4 8')
env.UnitArgs('test_TreeK-D2-R4-L10.out','#/bin/test_TreeK', ARGS='2 4 10')
env.UnitArgs('test_TreeK-D2-R4-L11.out','#/bin/test_TreeK', ARGS='2 4 11')
env.UnitArgs('test_TreeK-D2-R4-L12.out','#/bin/test_TreeK', ARGS='2 4 12')

env.UnitArgs('test_TreeK-D3-R2-L6.out', '#/bin/test_TreeK', ARGS='3 2 6')
env.UnitArgs('test_TreeK-D3-R2-L7.out', '#/bin/test_TreeK', ARGS='3 2 7')
env.UnitArgs('test_TreeK-D3-R2-L8.out', '#/bin/test_TreeK', ARGS='3 2 8')
env.UnitArgs('test_TreeK-D3-R4-L6.out', '#/bin/test_TreeK', ARGS='3 4 6')
env.UnitArgs('test_TreeK-D3-R4-L7.out', '#/bin/test_TreeK', ARGS='3 4 7')
env.UnitArgs('test_TreeK-D3-R4-L8.out', '#/bin/test_TreeK', ARGS='3 4 8')

env.UnitArgs('test_ppml_implosion.out', '#/bin/test_ppml', ARGS='ppml-implosion3 32 1')
env.UnitArgs('test_ppml_blast.out',     '#/bin/test_ppml', ARGS='ppml-blast      32 1')

env.UnitArgs('test_ppm_image.out',      '#/bin/test_ppm',  ARGS='ppm-image     100 10')
env.UnitArgs('test_ppm_implosion.out',  '#/bin/test_ppm',  ARGS='ppm-implosion 100 3')
env.UnitArgs('test_ppm_implosion3.out', '#/bin/test_ppm',  ARGS='ppm-implosion3 32 3')

env.UnitMpi('test_affinity.out', '#/bin/test_Affinity')
env.UnitMpi('test_mpi.out',      '#/bin/test_Mpi')

env.UnitMpi('test_Monitor.out',  '#/bin/test_Monitor')

env.UnitParse('test_parse_groups.out',     '#/bin/test_Parse', ARGS='test/parse_groups.in')
env.UnitParse('test_parse_integer.out',    '#/bin/test_Parse', ARGS='test/parse_integer.in')
env.UnitParse('test_parse_list.out',       '#/bin/test_Parse', ARGS='test/parse_list.in')
env.UnitParse('test_parse_logical.out',    '#/bin/test_Parse', ARGS='test/parse_logical.in')
env.UnitParse('test_parse_scalar.out',     '#/bin/test_Parse', ARGS='test/parse_scalar.in')
env.UnitParse('test_parse_implosion.out',  '#/bin/test_Parse', ARGS='test/parse_implosion.in')
env.UnitParse('test_parse_shock-pool.out', '#/bin/test_Parse', ARGS='test/parse_shock-pool.in')

env.TestCello('cello_implosion.out',  '#/bin/cello', ARGS='test/parse_implosion.in')



env.Unit('test_EnzoPpm.out', '#/bin/test_enzo_ppm')
env.Unit('test_EnzoPpml.out','#/bin/test_enzo_ppml')

# env.Unit('Array.unit','test_tree')
# env.Unit('Array.unit','test_tree_k')
#	./test_Parse < shock-pool.in > shock-pool.out
#	./test_Parse < test_groups.in > test_groups.out
#	./test_Parse < test.in > test.out
#	./test_Parse < test_list.in > test_list.out
#	./test_Parse < test_logical.in > test_logical.out
#	./test_Parse < test_scalar.in > test_scalar.out
#	-grep -i -l error *.out
